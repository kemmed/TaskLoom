@startuml AssignCategories
actor Пользователь as User
participant "Веб-браузер" as Browser
participant "Контроллер проекта" as PC
participant "Сервис проекта и пользователя" as UPS
participant "База данных" as DB

User -> Browser: Открыть страницу настроек проекта
Browser -> PC: GET /Projects/ProjectSettings/{projectID}
PC -> UPS: Получить текущего пользователя
UPS -> DB: Выполнить запрос для получения пользователя
DB --> UPS: Возвращаем текущего пользователя
UPS --> PC: Возвращаем текущего пользователя

PC -> UPS: Получить проект по ID
UPS -> DB: Выполнить запрос для получения проекта
DB --> UPS: Возвращаем проект
UPS --> PC: Возвращаем проект

alt Проект и пользователь найдены
    PC -> Browser: Вернуть страницу настроек проекта с данными проекта и пользователями

    User -> Browser: Выбрать категории для пользователя и отправить форму
    Browser -> PC: POST /Projects/AssignCategoriesToUser с userProjectID, projectID и selectedCategories

    PC -> UPS: Получить текущего пользователя
    UPS -> DB: Выполнить запрос для получения пользователя
    DB --> UPS: Возвращаем текущего пользователя
    UPS --> PC: Возвращаем текущего пользователя

    PC -> UPS: Получить проект по ID
    UPS -> DB: Выполнить запрос для получения проекта
    DB --> UPS: Возвращаем проект
    UPS --> PC: Возвращаем проект

    PC -> DB: Получить связь проекта с пользователем по ID
    DB --> PC: Возвращаем связь

    alt Связь проекта с пользователем найдена
        PC -> DB: Получить все категории проекта
        DB --> PC: Возвращаем все категории проекта

        PC -> DB: Очистить существующие категории пользователя
        DB --> PC: Подтверждение очистки категорий

        alt Категории выбраны
            PC -> DB: Добавить выбранные категории к пользователю
            DB --> PC: Подтверждение добавления категорий

            PC -> DB: Добавить запись в лог
            DB --> PC: Подтверждение добавления записи в лог

            PC -> DB: Сохранить изменения
            DB --> PC: Подтверждение сохранения

            PC -> Browser: Перенаправить на страницу настроек проекта
        else Категории не выбраны
            PC -> DB: Добавить запись в лог
            DB --> PC: Подтверждение добавления записи в лог

            PC -> DB: Сохранить изменения
            DB --> PC: Подтверждение сохранения

            PC -> Browser: Перенаправить на страницу настроек проекта
        end
    else  Связь проекта с пользователем не найдена
        PC -> Browser: Перенаправить на страницу ошибки
    end
else Проект или пользователь не найдены
    PC -> Browser: Перенаправить на страницу ошибки
end
@enduml