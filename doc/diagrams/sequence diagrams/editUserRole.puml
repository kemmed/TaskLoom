@startuml EditUserRole
actor Пользователь as User
participant "Веб-браузер" as Browser
participant "Контроллер проекта" as PC
participant "Сервис проекта и пользователя" as UPS
participant "База данных" as DB

User -> Browser: Открыть страницу настроек проекта
Browser -> PC: GET /Projects/ProjectSettings/{projectID}
PC -> UPS: Получить текущего пользователя
UPS -> DB: Выполнить запрос для получения пользователя
DB --> UPS: Возвращаем текущего пользователя
UPS --> PC: Возвращаем текущего пользователя

PC -> UPS: Получить проект по ID
UPS -> DB: Выполнить запрос для получения проекта
DB --> UPS: Возвращаем проект
UPS --> PC: Возвращаем проект

alt Проект и пользователь найдены
    PC -> UPS: Получить пользователя проекта по ID
    UPS -> DB: Выполнить запрос для получения пользователя проекта
    DB --> UPS: Возвращаем пользователя проекта
    UPS --> PC: Возвращаем пользователя проекта

    alt Пользователь проекта найден
        PC -> Browser: Вернуть страницу настроек проекта с данными пользователя проекта

        User -> Browser: Выбрать новую роль для пользователя и отправить форму
        Browser -> PC: POST /Projects/EditUserRole с userProjectID и newRole

        PC -> UPS: Получить текущего пользователя
        UPS -> DB: Выполнить запрос для получения пользователя
        DB --> UPS: Возвращаем текущего пользователя
        UPS --> PC: Возвращаем текущего пользователя

        PC -> UPS: Получить проект по ID
        UPS -> DB: Выполнить запрос для получения проекта
        DB --> UPS: Возвращаем проект
        UPS --> PC: Возвращаем проект

        PC -> UPS: Получить пользователя проекта по ID
        UPS -> DB: Выполнить запрос для получения пользователя проекта
        DB --> UPS: Возвращаем пользователя проекта
        UPS --> PC: Возвращаем пользователя проекта

        alt Проект и пользователи найдены
            alt Новая роль - Администратор
                PC -> DB: Обновить роль пользователя на Администратор
                DB --> PC: Подтверждение обновления роли

                PC -> DB: Обновить роль текущего пользователя на Сотрудник
                DB --> PC: Подтверждение обновления роли

                PC -> DB: Добавить запись в лог
                DB --> PC: Подтверждение добавления записи в лог

                PC -> DB: Сохранить изменения
                DB --> PC: Подтверждение сохранения

                PC -> Browser: Перенаправить на страницу настроек проекта
            else Новая роль - Менеджер или Сотрудник
                PC -> DB: Обновить роль пользователя на новую роль
                DB --> PC: Подтверждение обновления роли

                PC -> DB: Добавить запись в лог
                DB --> PC: Подтверждение добавления записи в лог

                PC -> DB: Сохранить изменения
                DB --> PC: Подтверждение сохранения

                PC -> Browser: Перенаправить на страницу настроек проекта
            end
        else Проект или пользователи не найдены
            PC -> Browser: Перенаправить на страницу ошибки
        end
    else Пользователь проекта не найден
        PC -> Browser: Перенаправить на страницу ошибки
    end
else Проект или пользователь не найдены
    PC -> Browser: Перенаправить на страницу ошибки
end
@enduml